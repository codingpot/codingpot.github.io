<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Okteto에 Deployment를 롤아웃 하기 | 코딩냄비 부글부글</title><meta name=description content="코딩냄비 프로젝트를 진행하며 배운것을 기록합니다."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Okteto에 Deployment를 롤아웃 하기"><meta property="og:description" content="코딩냄비 프로젝트 중 pr12er는 TensorFlow Korea의 논문을 읽고/리뷰하는 모임 PR12에서 촬영된 동영상을 큐레이션하는 프로젝트입니다. 개략적으로 프론트엔드는 Flutter, 백엔드는 Go로 작성되었으며, 이 둘간의 인터페이스는 gRPC/protobuf로 구성되어있습니다. 특히 pr12er 프로젝트의 백엔드 서버는 PR이 Merge 됨과 동시에 Okteto가 제공하는k8s 에 배포되는 CD 루틴을 탑니다.
 이 글은 Okteto 에 배포하기위한 파이프라인을 분석하는 총 3편의 시리즈물 중 마지막입니다.
 Okteto 파이프라인 개요, okteto build, pr12er 서버용 Dockerfile 분석 Okteto에 gRPC용 Deployment, Service, Ingress 설정 정적 yaml 파일의 설정을 동적으로 바꾸기  pr12er에 적용된 Okteto 파이프라인 명세서 1 2 3 4 5 6  deploy: # - okteto build -t okteto."><meta property="og:type" content="article"><meta property="og:url" content="https://codingpot.github.io/posts/2021-06-16-okteto-kubectl-set/"><meta property="article:published_time" content="2021-06-16T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-16T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Okteto에 Deployment를 롤아웃 하기"><meta name=twitter:description content="코딩냄비 프로젝트 중 pr12er는 TensorFlow Korea의 논문을 읽고/리뷰하는 모임 PR12에서 촬영된 동영상을 큐레이션하는 프로젝트입니다. 개략적으로 프론트엔드는 Flutter, 백엔드는 Go로 작성되었으며, 이 둘간의 인터페이스는 gRPC/protobuf로 구성되어있습니다. 특히 pr12er 프로젝트의 백엔드 서버는 PR이 Merge 됨과 동시에 Okteto가 제공하는k8s 에 배포되는 CD 루틴을 탑니다.
 이 글은 Okteto 에 배포하기위한 파이프라인을 분석하는 총 3편의 시리즈물 중 마지막입니다.
 Okteto 파이프라인 개요, okteto build, pr12er 서버용 Dockerfile 분석 Okteto에 gRPC용 Deployment, Service, Ingress 설정 정적 yaml 파일의 설정을 동적으로 바꾸기  pr12er에 적용된 Okteto 파이프라인 명세서 1 2 3 4 5 6  deploy: # - okteto build -t okteto."><link rel=stylesheet href=https://codingpot.github.io/css/style-white.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://codingpot.github.io/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a><a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a><a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast');" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a><span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://codingpot.github.io/posts/2021-06-15-okteto-kubectl-apply/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');" aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&text=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&title=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&is_video=false&description=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0&body=Check out this article: https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&title=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&title=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&name=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0&description=%ec%bd%94%eb%94%a9%eb%83%84%eb%b9%84%20%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8%20%ec%a4%91%20pr12er%eb%8a%94%20TensorFlow%20Korea%ec%9d%98%20%eb%85%bc%eb%ac%b8%ec%9d%84%20%ec%9d%bd%ea%b3%a0%2f%eb%a6%ac%eb%b7%b0%ed%95%98%eb%8a%94%20%eb%aa%a8%ec%9e%84%20PR12%ec%97%90%ec%84%9c%20%ec%b4%ac%ec%98%81%eb%90%9c%20%eb%8f%99%ec%98%81%ec%83%81%ec%9d%84%20%ed%81%90%eb%a0%88%ec%9d%b4%ec%85%98%ed%95%98%eb%8a%94%20%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8%ec%9e%85%eb%8b%88%eb%8b%a4.%20%ea%b0%9c%eb%9e%b5%ec%a0%81%ec%9c%bc%eb%a1%9c%20%ed%94%84%eb%a1%a0%ed%8a%b8%ec%97%94%eb%93%9c%eb%8a%94%20Flutter%2c%20%eb%b0%b1%ec%97%94%eb%93%9c%eb%8a%94%20Go%eb%a1%9c%20%ec%9e%91%ec%84%b1%eb%90%98%ec%97%88%ec%9c%bc%eb%a9%b0%2c%20%ec%9d%b4%20%eb%91%98%ea%b0%84%ec%9d%98%20%ec%9d%b8%ed%84%b0%ed%8e%98%ec%9d%b4%ec%8a%a4%eb%8a%94%20gRPC%2fprotobuf%eb%a1%9c%20%ea%b5%ac%ec%84%b1%eb%90%98%ec%96%b4%ec%9e%88%ec%8a%b5%eb%8b%88%eb%8b%a4.%20%ed%8a%b9%ed%9e%88%20pr12er%20%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8%ec%9d%98%20%eb%b0%b1%ec%97%94%eb%93%9c%20%ec%84%9c%eb%b2%84%eb%8a%94%20PR%ec%9d%b4%20Merge%20%eb%90%a8%ea%b3%bc%20%eb%8f%99%ec%8b%9c%ec%97%90%20Okteto%ea%b0%80%20%ec%a0%9c%ea%b3%b5%ed%95%98%eb%8a%94k8s%20%ec%97%90%20%eb%b0%b0%ed%8f%ac%eb%90%98%eb%8a%94%20CD%20%eb%a3%a8%ed%8b%b4%ec%9d%84%20%ed%83%91%eb%8b%88%eb%8b%a4.%0a%20%ec%9d%b4%20%ea%b8%80%ec%9d%80%20Okteto%20%ec%97%90%20%eb%b0%b0%ed%8f%ac%ed%95%98%ea%b8%b0%ec%9c%84%ed%95%9c%20%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8%ec%9d%84%20%eb%b6%84%ec%84%9d%ed%95%98%eb%8a%94%20%ec%b4%9d%203%ed%8e%b8%ec%9d%98%20%ec%8b%9c%eb%a6%ac%ec%a6%88%eb%ac%bc%20%ec%a4%91%20%eb%a7%88%ec%a7%80%eb%a7%89%ec%9e%85%eb%8b%88%eb%8b%a4.%0a%20Okteto%20%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8%20%ea%b0%9c%ec%9a%94%2c%20okteto%20build%2c%20pr12er%20%ec%84%9c%eb%b2%84%ec%9a%a9%20Dockerfile%20%eb%b6%84%ec%84%9d%20Okteto%ec%97%90%20gRPC%ec%9a%a9%20Deployment%2c%20Service%2c%20Ingress%20%ec%84%a4%ec%a0%95%20%ec%a0%95%ec%a0%81%20yaml%20%ed%8c%8c%ec%9d%bc%ec%9d%98%20%ec%84%a4%ec%a0%95%ec%9d%84%20%eb%8f%99%ec%a0%81%ec%9c%bc%eb%a1%9c%20%eb%b0%94%ea%be%b8%ea%b8%b0%20%20pr12er%ec%97%90%20%ec%a0%81%ec%9a%a9%eb%90%9c%20Okteto%20%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8%20%eb%aa%85%ec%84%b8%ec%84%9c%201%202%203%204%205%206%20%20deploy%3a%20%23%20-%20okteto%20build%20-t%20okteto." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&t=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#kubectl-set-image>kubectl set image</a><ul><li><a href=#왜-필요한가>왜 필요한가?</a></li><li><a href=#okteto-에서는-필요없습니다>Okteto 에서는 필요없습니다.</a></li></ul></li><li><a href=#kubectl-rollout-restart>kubectl rollout restart</a></li><li><a href=#kubectl-rollout-status>kubectl rollout status</a></li><li><a href=#참고자료>참고자료</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Okteto에 Deployment를 롤아웃 하기</h1><div class=meta><div class=postdate><time datetime="2021-06-16 00:00:00 +0000 UTC" itemprop=datePublished>2021-06-16</time></div><div class=article-tag><i class="fas fa-tag"></i><a class=tag-link href=/tags/okteto rel=tag>okteto</a>
,
<a class=tag-link href=/tags/kubectl rel=tag>kubectl</a>
,
<a class=tag-link href=/tags/kubectl-set-image rel=tag>kubectl-set-image</a>
,
<a class=tag-link href=/tags/kubectl-rollout-restart rel=tag>kubectl-rollout-restart</a>
,
<a class=tag-link href=/tags/kubectl-rollout-status rel=tag>kubectl-rollout-status</a></div></div></header><div class=content itemprop=articleBody><blockquote><p>코딩냄비 프로젝트 중 <strong>pr12er</strong>는 TensorFlow Korea의 논문을 읽고/리뷰하는 모임 PR12에서 촬영된 동영상을 큐레이션하는 프로젝트입니다. 개략적으로 프론트엔드는 <strong>Flutter</strong>, 백엔드는 <strong>Go</strong>로 작성되었으며, 이 둘간의 인터페이스는 <strong>gRPC/protobuf</strong>로 구성되어있습니다. 특히 <strong>pr12er</strong> 프로젝트의 백엔드 서버는 <strong>PR</strong>이 <strong>Merge</strong> 됨과 동시에 <strong>Okteto</strong>가 제공하는<strong>k8s</strong> 에 배포되는 <strong>CD</strong> 루틴을 탑니다.</p></blockquote><p>이 글은 <strong>Okteto</strong> 에 배포하기위한 파이프라인을 분석하는 총 3편의 시리즈물 중 마지막입니다.</p><ol><li><a href=https://codingpot.github.io/posts/2021-06-11-okteto-pipeline-build/><strong>Okteto</strong> 파이프라인 개요, <strong>okteto build</strong>, <strong>pr12er</strong> 서버용 <strong>Dockerfile</strong> 분석</a></li><li><a href=https://codingpot.github.io/posts/2021-06-16-okteto-kubectl-apply/><strong>Okteto</strong>에 gRPC용 <strong>Deployment</strong>, <strong><strong>Service</strong></strong>, <strong>Ingress</strong> 설정</a></li><li><a href=https://codingpot.github.io/posts/2021-06-16-okteto-kubectl-set/><strong>정적 yaml 파일의 설정을 동적으로 바꾸기</strong></a></li></ol><h1 id=pr12er에-적용된-okteto-파이프라인-명세서><strong>pr12er</strong>에 적용된 <strong>Okteto</strong> 파이프라인 명세서</h1><div class=highlight><div style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#5bc4bf>deploy</span>:
<span style=color:#776e71>#  - okteto build -t okteto.dev/codingpot-pr12er-server:${OKTETO_GIT_COMMIT} -f ./server/deploy/Dockerfile server</span>
<span style=color:#776e71>#  - for file in k8s/kkweon-okteto/*.yaml; do envsubst &lt; $file | kubectl apply -f -; done</span>
  - <span style=color:#f99b15>kubectl set image deployment server server=okteto.dev/codingpot-pr12er-server:${OKTETO_GIT_COMMIT}</span>
  - <span style=color:#f99b15>kubectl rollout restart deployment grafana-agent</span>
  - <span style=color:#f99b15>kubectl rollout status deployment server &amp;&amp; kubectl rollout status deployment grafana-agent</span>
</code></pre></td></tr></table></div></div><h2 id=kubectl-set-image>kubectl set image</h2><p>이미 존재하는 컨테이너의 이미지를 갱신하는 명령어로 완전한 형식은 다음과 같습니다.</p><div class=highlight><div style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>&gt; kubectl set image <span style=color:#5bc4bf>(</span>-f FILENAME | TYPE NAME<span style=color:#5bc4bf>)</span> <span style=color:#f99b15>\
</span><span style=color:#f99b15></span>  <span style=color:#ef6155>CONTAINER_NAME_1</span><span style=color:#5bc4bf>=</span>CONTAINER_IMAGE_1 ... <span style=color:#ef6155>CONTAINER_NAME_N</span><span style=color:#5bc4bf>=</span>CONTAINER_IMAGE_N
</code></pre></td></tr></table></div></div><p>여기서 <strong>TYPE</strong> 이라는 부분에는 <strong>pod</strong>, <strong>replicationcontroller</strong>, <strong>deployment</strong>, <strong>daemonset</strong>, <strong>replicaset</strong> 이라는 키워드가 올 수 있습니다. 즉 이 블로그 시리즈물에서는 <strong>Deployment</strong> 만을 다뤘지만, 그 외에도 콘테이너 스펙을 명시할 수 있는 쿠버네티스의 객체 종류가 다양합니다. 또한 <strong>TYPE NAME</strong> 대신 <strong>-f</strong> 옵션을 사용하면 파일명 자체를 지정할 수도 있으며, 하나의 <strong>Deployment</strong> 에 포함 가능한 여러개의 컨테이너 명세서를 원하는 만큼 갱신할 수도 있습니다.</p><p>그러면 <strong>pr12er</strong> 에서 이 명령어가 어떻게 사용되었는지를 말로 풀어 설명해보겠습니다.</p><div class=highlight><div style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>&gt; kubectl set image deployment server <span style=color:#f99b15>\
</span><span style=color:#f99b15></span>  <span style=color:#ef6155>server</span><span style=color:#5bc4bf>=</span>okteto.dev/codingpot-pr12er-server:<span style=color:#f99b15>${</span><span style=color:#ef6155>OKTETO_GIT_COMMIT</span><span style=color:#f99b15>}</span>
</code></pre></td></tr></table></div></div><p><strong>server</strong> 라는 이름의 <strong>Deployment</strong> 객체를 대상으로 지정합니다. 그리고는 해당 <strong>Deployment</strong>에 정의된 컨테이너 중 <strong>server</strong> 라는 이름의 컨테이너를 찾아서 이미지를 <strong>okteto.dev/codingpot-pr12er-server:${OKTETO_GIT_COMMIT}</strong> 으로 설정합니다. 이 그림은 두 번째 게시글에서 본 yaml 파일을 참조하면 매우 명확해 집니다.</p><div class=highlight><div style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#5bc4bf>kind</span>: <span style=color:#f99b15>Deployment</span>
<span style=color:#5bc4bf>metadata</span>:
  <span style=color:#776e71># ommited</span>
  <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>server</span>
<span style=color:#5bc4bf>spec</span>:
  <span style=color:#776e71># ommited</span>
  <span style=color:#5bc4bf>template</span>:
    <span style=color:#5bc4bf>spec</span>:
      <span style=color:#5bc4bf>containers</span>:
        - <span style=color:#5bc4bf>image</span>: <span style=color:#f99b15>okteto.dev/codingpot-pr12er-server</span>
          <span style=color:#5bc4bf>name</span>: <span style=color:#f99b15>server</span>
  <span style=color:#776e71># ommited</span>
</code></pre></td></tr></table></div></div><p><strong>종류(kind)</strong> 가 <strong>Deployment</strong> 이며, 부여된 <strong>이름(metadata.name)</strong> 은 <strong>server</strong> 이고, 여기에 포함된 컨테이너 중 <strong>이름(spec.template.spec.containers.name)</strong> 이 <strong>server</strong> 인 녀석의 <strong>이미지(image)</strong> 를 교체 대상으로 특정한 것입니다.</p><h3 id=왜-필요한가>왜 필요한가?</h3><p>그렇다면 <strong>kubectl set image</strong>와 같은 명령어는 왜 필요할까요?</p><p>앞서 정의된 <strong>Deployment</strong> 에는 이미지 태그 정보가 동적으로 유연하게 삽입되지 않습니다. 하지만 소스코드가 문제 없이 빌드되고, 이에 대한 풀 리퀘스트가 정상적으로 수용된다면, 최신 버전으로 빌드된 컨테이너 이미지로 교체되어야 CI/CD가 잘 이루어진다고 볼 수 있겠죠. <strong>kubectl set image</strong>는 바로 이 상황을 위한 것입니다.</p><p>한 가지 알아둘 점은 <strong>kubectl set image</strong> 라는 명령이 하달된다고 해서, 그 즉시 쿠버네티스가 현존하는 모든 컨테이너를 제거하고 새로운 이미지로 갈아끼워 서비스 중단이라는 사태가 발생하는것은 아닙니다. 이 명령은 <em>즉시 액션을 취하시오</em> 라는 말이 아니라, 현재 서빙되는 것은 건들지 않은채 새 컨테이너를 담은 <strong>Pod</strong>을 만든 다음, 해당 <strong>Pod</strong>이 완전히 부팅되었을 때 교체하라는 의미 정도로 생각할 수 있습니다.</p><h3 id=okteto-에서는-필요없습니다>Okteto 에서는 필요없습니다.</h3><p><strong>Okteto</strong> 에서는 <strong>okteto build</strong> 명령을 수행하면, 내부적으로 이미지 업데이트도 함께 수행하기 때문에 명시적으로 <strong>kubectl set image</strong> 명령을 실행할 필요는 없습니다.</p><p>하지만 <strong>kubectl set image</strong> 명령을 실행한다고 해서 어떤 불이익이 발생하는것은 아닙니다. 만약 <strong>kubectl set image</strong>를 실행했는데, 이미 <strong>Okteto</strong>가 갈아끼운 이미지와 동일하다면 아무런 액션도 발생하지 않기 때문이죠. 따라서 <strong>Okteto</strong> 만을 사용하지 않는 우리는 기본적으로 <strong>kubectl set image</strong> 명령을 항상 적용하는것이 베스트 프랙티스라고 볼 수 있습니다.</p><h2 id=kubectl-rollout-restart>kubectl rollout restart</h2><p>이미 존재하는 쿠버네티스의 자원을 재시작하는 완전한 명령어는 다음과 같습니다.</p><div class=highlight><div style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>&gt; kubectl rollout restart TYPE NAME <span style=color:#5bc4bf>[</span>flags<span style=color:#5bc4bf>]</span>
</code></pre></td></tr></table></div></div><p>말 그대로 지정된 자원을 재시작하는 명령어로, 이미 적용된 것이 있다면 새로운 설정이 들어간 녀석으로 교체하는것이 가능합니다. <strong>pr12er</strong> 프로젝트에서는 <strong>grafana-agent</strong> 라는 이름의 <strong>Deployment</strong> 자원을 재시작 하는 용도로 이 명령이 사용되었습니다. 그 이유는 <strong>grafana-agent</strong> 에 포함된 그라파나 에이전트에 대한 설정이 들어간 <strong>ConfigMap</strong> 의 정보가 바뀔 수 있기 때문입니다.</p><p>이 명령 또한 <strong>kubectl set image</strong> 처럼, 강제로 새로 시작하라는 명령을 쿠버네티스에 하달하는것은 아닙니다. 새로운 Pod이 생성되고 이 새로운 Pod은 만약 configmap이 업데이트 되었다면 새로운 configmap을 가지고 있습니다.</p><p>만약 <code>kubectl rollout restart</code> 를 해주지 않는다면, 그대로 (구 configmap을 가진채로) 아무 일도 일어나지 않습니다.</p><h2 id=kubectl-rollout-status>kubectl rollout status</h2><p>롤아웃된 상태를 체크하는 완전한 명령어는 다음과 같습니다.</p><div class=highlight><div style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>&gt; kubectl rollout status <span style=color:#5bc4bf>(</span>TYPE NAME<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>[</span>flags<span style=color:#5bc4bf>]</span>
</code></pre></td></tr></table></div></div><blockquote><p>By default &lsquo;rollout status&rsquo; will watch the status of the latest rollout <strong>until it&rsquo;s done.</strong></p></blockquote><p>이 명령은 현재 롤아웃되는 자원의 상태를 지속적으로 체크합니다. 그리고 롤아웃이 완료될 때까지 그 체크는 계속되며 완전히 롤아웃이 완료될 때까지 기다리게 됩니다. 롤아웃이 완료되었다고 판단되는 시점은 다음 세 조건을 충족했을 때입니다 <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#deployment-status>링크</a>.</p><ul><li>해당 <strong>Deployment</strong>에 연관된 모든 <strong>Pod(replica에 명시된 수만큼)</strong> 들이 새로운 버전으로 갱신됨</li><li>새로운 버전으로 채워진 <strong>Pod</strong> 들이 가용상태가 됨</li><li>이전 버전의 <strong>Pod</strong> 들이 완전히 셧다운됨 (남은 놈들이 없음)</li></ul><p>이 명령이 실행되면 콘솔 창에는 아래와 유사한 메시지가 출력되며, 성공적으로 롤아웃이 완료됨의 여부는 <strong>exit status</strong> 를 검사해 보면 알 수 있습니다. <strong>exit status</strong> 는 <strong>$?</strong> 로 접근할 수 있으므로, 만약 성공적으로 롤아웃된 경우 이 값을 출력하면 <strong>0</strong> 이라는 값을 얻게됩니다.</p><div class=highlight><div style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>Waiting <span style=color:#815ba4>for</span> rollout to finish: <span style=color:#f99b15>1</span> of <span style=color:#f99b15>1</span> updated replicas are available...
deployment <span style=color:#48b685>&#34;server&#34;</span> successfully rolled out
</code></pre></td></tr></table></div></div><h2 id=참고자료>참고자료</h2><ul><li><p><strong>kubectl set image</strong></p><ul><li><a href=https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#-em-image-em->https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#-em-image-em-</a></li></ul></li><li><p><strong>kubectl rollout restart</strong></p><ul><li><a href=https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#-em-restart-em->https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#-em-restart-em-</a></li></ul></li><li><p><strong>kubectl rollout status</strong></p><ul><li><a href=https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#-em-status-em->https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#-em-status-em-</a></li></ul></li></ul></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#kubectl-set-image>kubectl set image</a><ul><li><a href=#왜-필요한가>왜 필요한가?</a></li><li><a href=#okteto-에서는-필요없습니다>Okteto 에서는 필요없습니다.</a></li></ul></li><li><a href=#kubectl-rollout-restart>kubectl rollout restart</a></li><li><a href=#kubectl-rollout-status>kubectl rollout status</a></li><li><a href=#참고자료>참고자료</a></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&text=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&title=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&is_video=false&description=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0&body=Check out this article: https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&title=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&title=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&name=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0&description=%ec%bd%94%eb%94%a9%eb%83%84%eb%b9%84%20%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8%20%ec%a4%91%20pr12er%eb%8a%94%20TensorFlow%20Korea%ec%9d%98%20%eb%85%bc%eb%ac%b8%ec%9d%84%20%ec%9d%bd%ea%b3%a0%2f%eb%a6%ac%eb%b7%b0%ed%95%98%eb%8a%94%20%eb%aa%a8%ec%9e%84%20PR12%ec%97%90%ec%84%9c%20%ec%b4%ac%ec%98%81%eb%90%9c%20%eb%8f%99%ec%98%81%ec%83%81%ec%9d%84%20%ed%81%90%eb%a0%88%ec%9d%b4%ec%85%98%ed%95%98%eb%8a%94%20%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8%ec%9e%85%eb%8b%88%eb%8b%a4.%20%ea%b0%9c%eb%9e%b5%ec%a0%81%ec%9c%bc%eb%a1%9c%20%ed%94%84%eb%a1%a0%ed%8a%b8%ec%97%94%eb%93%9c%eb%8a%94%20Flutter%2c%20%eb%b0%b1%ec%97%94%eb%93%9c%eb%8a%94%20Go%eb%a1%9c%20%ec%9e%91%ec%84%b1%eb%90%98%ec%97%88%ec%9c%bc%eb%a9%b0%2c%20%ec%9d%b4%20%eb%91%98%ea%b0%84%ec%9d%98%20%ec%9d%b8%ed%84%b0%ed%8e%98%ec%9d%b4%ec%8a%a4%eb%8a%94%20gRPC%2fprotobuf%eb%a1%9c%20%ea%b5%ac%ec%84%b1%eb%90%98%ec%96%b4%ec%9e%88%ec%8a%b5%eb%8b%88%eb%8b%a4.%20%ed%8a%b9%ed%9e%88%20pr12er%20%ed%94%84%eb%a1%9c%ec%a0%9d%ed%8a%b8%ec%9d%98%20%eb%b0%b1%ec%97%94%eb%93%9c%20%ec%84%9c%eb%b2%84%eb%8a%94%20PR%ec%9d%b4%20Merge%20%eb%90%a8%ea%b3%bc%20%eb%8f%99%ec%8b%9c%ec%97%90%20Okteto%ea%b0%80%20%ec%a0%9c%ea%b3%b5%ed%95%98%eb%8a%94k8s%20%ec%97%90%20%eb%b0%b0%ed%8f%ac%eb%90%98%eb%8a%94%20CD%20%eb%a3%a8%ed%8b%b4%ec%9d%84%20%ed%83%91%eb%8b%88%eb%8b%a4.%0a%20%ec%9d%b4%20%ea%b8%80%ec%9d%80%20Okteto%20%ec%97%90%20%eb%b0%b0%ed%8f%ac%ed%95%98%ea%b8%b0%ec%9c%84%ed%95%9c%20%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8%ec%9d%84%20%eb%b6%84%ec%84%9d%ed%95%98%eb%8a%94%20%ec%b4%9d%203%ed%8e%b8%ec%9d%98%20%ec%8b%9c%eb%a6%ac%ec%a6%88%eb%ac%bc%20%ec%a4%91%20%eb%a7%88%ec%a7%80%eb%a7%89%ec%9e%85%eb%8b%88%eb%8b%a4.%0a%20Okteto%20%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8%20%ea%b0%9c%ec%9a%94%2c%20okteto%20build%2c%20pr12er%20%ec%84%9c%eb%b2%84%ec%9a%a9%20Dockerfile%20%eb%b6%84%ec%84%9d%20Okteto%ec%97%90%20gRPC%ec%9a%a9%20Deployment%2c%20Service%2c%20Ingress%20%ec%84%a4%ec%a0%95%20%ec%a0%95%ec%a0%81%20yaml%20%ed%8c%8c%ec%9d%bc%ec%9d%98%20%ec%84%a4%ec%a0%95%ec%9d%84%20%eb%8f%99%ec%a0%81%ec%9c%bc%eb%a1%9c%20%eb%b0%94%ea%be%b8%ea%b8%b0%20%20pr12er%ec%97%90%20%ec%a0%81%ec%9a%a9%eb%90%9c%20Okteto%20%ed%8c%8c%ec%9d%b4%ed%94%84%eb%9d%bc%ec%9d%b8%20%eb%aa%85%ec%84%b8%ec%84%9c%201%202%203%204%205%206%20%20deploy%3a%20%23%20-%20okteto%20build%20-t%20okteto." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fcodingpot.github.io%2fposts%2f2021-06-16-okteto-kubectl-set%2f&t=Okteto%ec%97%90%20Deployment%eb%a5%bc%20%eb%a1%a4%ec%95%84%ec%9b%83%20%ed%95%98%ea%b8%b0" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick="$('#nav-footer').toggle();return false;" aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i>Menu</a>
<a id=toc-toggle class=icon href=# onclick="$('#toc-footer').toggle();return false;" aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i>TOC</a>
<a id=share-toggle class=icon href=# onclick="$('#share-footer').toggle();return false;" aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i>share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i>Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2021 코딩냄비</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>